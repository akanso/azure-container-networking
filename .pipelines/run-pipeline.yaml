stages:
- stage: setup
  displayName: ACN
  variables:
    ACN_DIR: azure-container-networking
  jobs:
  - job: env
    displayName: Setup
    pool:
      type: linux
    variables:
      ob_outputDirectory: $(Build.ArtifactStagingDirectory)
      ob_artifactSuffix: _source

      ACR_DIR: $(Build.SourcesDirectory)/azure-container-networking
    steps:
    - checkout: azure-container-networking
    - template: build/ob-prepare.steps.yaml

- template: templates/run-unit-tests.yaml


- ${{ if not(contains(variables['Build.SourceBranch'], 'refs/pull')) }}:
  - stage: build
    displayName: "Build Project"
    dependsOn:
      - setup
      - test
    variables:
      ACN_DIR: drop_setup_env_source
      ACN_PACKAGE_PATH: github.com/Azure/azure-container-networking
      CNI_AI_PATH: $(ACN_PACKAGE_PATH)/telemetry.aiMetadata
      CNS_AI_PATH: $(ACN_PACKAGE_PATH)/cns/logger.aiMetadata
      NPM_AI_PATH: $(ACN_PACKAGE_PATH)/npm.aiMetadata

      STORAGE_ID: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.StorageID'] ]
      TAG: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.Tag'] ]
      AZURE_IPAM_VERSION: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.azureIpamVersion'] ]
      CNI_VERSION: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.cniVersion'] ]
      CNS_VERSION: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.cnsVersion'] ]
      IPV6_HP_BPF_VERSION: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.ipv6HpBpfVersion'] ]
      NPM_VERSION: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.npmVersion'] ]
    jobs:
    - job: binaries
      displayName: "Build Binaries"
      pool:
        type: linux
        vmImage: $(LinuxContainerImage2)
      variables:
        ob_outputDirectory: $(Build.ArtifactStagingDirectory)/output
        ob_git_checkout: true
        ob_enable_qemu: true
    
        ACN_DIR: azure-container-networking
      steps:
      - checkout: azure-container-networking
      - template: build/binaries.steps.yaml


    - job: images_linux_amd64
      displayName: "Build Linux/AMD64 Images"
      pool:
        os: linux
        type: docker
      variables:
        ob_outputDirectory: $(Build.SourcesDirectory)/out
        ob_artifactSuffix: _$(name)_linux_amd64

        ARCH: amd64
        OS: linux
      strategy:
        maxParallel: 5
        matrix:
          azure_ipam:
            name: $(os)_$(arch)/azure-ipam
            dockerfilePath: $(ACN_DIR)/azure-ipam
            extraArgs: ''
            archiveName: azure-ipam
            archiveVersion: $(AZURE_IPAM_VERSION)
            imageTag: $(Build.BuildNumber)
          cni:
            name: $(os)_$(arch)/cni
            dockerfilePath: $(ACN_DIR)/cni
            extraArgs: '--build-arg CNI_AI_PATH=$(CNI_AI_PATH) --build-arg CNI_AI_ID=$(CNI_AI_ID)'
            archiveName: azure-cni
            archiveVersion: $(CNI_VERSION)
            imageTag: $(Build.BuildNumber)
          cns:
            name: $(os)_$(arch)/cns
            dockerfilePath: $(ACN_DIR)/cns
            extraArgs: '--build-arg CNS_AI_PATH=$(CNS_AI_PATH) --build-arg CNS_AI_ID=$(CNS_AI_ID)'
            archiveName: azure-cns
            archiveVersion: $(CNS_VERSION)
            imageTag: $(Build.BuildNumber)
          ipv6_hp_bpf:
            name: $(os)_$(arch)/ipv6-hp-bpf
            dockerfilePath: $(ACN_DIR)/bpf-prog/ipv6-hp-bpf
            extraArgs: "--build-arg DEBUG=$(System.Debug)"
            archiveName: ipv6-hp-bpf
            archiveVersion: $(IPV6_HP_BPF_VERSION)
            imageTag: $(Build.BuildNumber)
          npm:
            name: $(os)_$(arch)/npm
            dockerfilePath: $(ACN_DIR)/npm
            extraArgs: '--build-arg NPM_AI_PATH=$(NPM_AI_PATH) --build-arg NPM_AI_ID=$(NPM_AI_ID)'
            archiveName: azure-npm
            archiveVersion: $(NPM_VERSION)
            imageTag: $(Build.BuildNumber)
      steps:
      - template: build/image.steps.yaml
        parameters:
          arch: $(ARCH)
          os: $(OS)
          name: $(name)
          dockerfile_path: $(dockerfilePath)
          build_tag: $(imageTag)
          extra_args: $(extraArgs)
          archive_file: $(archiveName)-$(OS)-$(ARCH)-$(archiveVersion)

    - job: images_windows_amd64
      displayName: "Build Windows Images"
      pool:
        os: linux
        type: docker
      variables:
        ob_outputDirectory: $(Build.SourcesDirectory)/out
        ob_artifactSuffix: _$(name)_windows_amd64
        ob_enable_qemu: true

        ARCH: amd64
        OS: windows
      strategy:
        maxParallel: 5
        matrix:
          azure_ipam:
            name: $(os)_$(arch)/azure-ipam
            osVersion: ltsc2022
            dockerfilePath: $(ACN_DIR)/azure-ipam
            extraArgs: ''
            archiveName: azure-ipam
            archiveVersion: $(OS)-$(ARCH)-$(AZURE_IPAM_VERSION)-ltsc2022
            imageTag: $(Build.BuildNumber)
          cni:
            name: $(os)_$(arch)/cni
            osVersion: ltsc2022
            dockerfilePath: $(ACN_DIR)/cni
            extraArgs: '--build-arg CNI_AI_PATH=$(CNI_AI_PATH) --build-arg CNI_AI_ID=$(CNI_AI_ID)'
            archiveName: azure-cni
            archiveVersion: $(CNI_VERSION)
            imageTag: $(Build.BuildNumber)
          cns:
            name: $(os)_$(arch)/cns
            osVersion: ltsc2022
            dockerfilePath: $(ACN_DIR)/cns
            extraArgs: '--build-arg CNS_AI_PATH=$(CNS_AI_PATH) --build-arg CNS_AI_ID=$(CNS_AI_ID)'
            archiveName: azure-cns
            archiveVersion: $(CNS_VERSION)
            imageTag: $(Build.BuildNumber)
          npm:
            name: $(os)_$(arch)/npm
            osVersion: ltsc2022
            dockerfilePath: $(ACN_DIR)/npm-windows
            extraArgs: '--build-arg NPM_AI_PATH=$(NPM_AI_PATH) --build-arg NPM_AI_ID=$(NPM_AI_ID)'
            archiveName: azure-npm
            archiveVersion: $(NPM_VERSION)
            # Note: Double check, I didn't notice a windows platform tag for npm in the Makefile
            imageTag: $(Build.BuildNumber)
      steps:
      - template: build/image.steps.yaml
        parameters:
          arch: $(ARCH)
          os: $(OS)
          os_version: $(osVersion)
          name: $(name)
          dockerfile_path: $(dockerfilePath)
          build_tag: $(imageTag)
          extra_args: $(extraArgs)
          archive_file: $(archiveName)-$(OS)-$(ARCH)-$(archiveVersion)
  
    - job: images_linux_arm64
      displayName: "Build Linux/ARM64 Images"
      pool:
        os: linux
        type: docker
        hostArchitecture: arm64
      variables:
        #LinuxContainerImage: $(LinuxContainerImage3) # Use if Mariner does not work.
        ob_outputDirectory: $(Build.SourcesDirectory)/out
        ob_artifactSuffix: _$(name)_linux_arm64
        ob_build_container: true

        ARCH: arm64
        OS: linux
      strategy:
        maxParallel: 3
        matrix:
          azure_ipam:
            name: $(os)_$(arch)/azure-ipam
            os: linux
            dockerfilePath: $(ACN_DIR)/azure-ipam
            archiveName: azure-ipam
            archiveVersion: $(AZURE_IPAM_VERSION)
            extraArgs: ''
            imageTag: $(Build.BuildNumber)
          cni:
            name: $(os)_$(arch)/cni
            os: linux
            dockerfilePath: $(ACN_DIR)/cni
            extraArgs: '--build-arg CNI_AI_PATH=$(CNI_AI_PATH) --build-arg CNI_AI_ID=$(CNI_AI_ID)'
            archiveName: azure-cni
            archiveVersion: $(CNI_VERSION)
            imageTag: $(Build.BuildNumber)
          cns:
            name: $(os)_$(arch)/cns
            os: linux
            dockerfilePath: $(ACN_DIR)/cns
            extraArgs: '--build-arg CNS_AI_PATH=$(CNS_AI_PATH) --build-arg CNS_AI_ID=$(CNS_AI_ID)'
            archiveName: azure-cns
            archiveVersion: $(CNS_VERSION)
            imageTag: $(Build.BuildNumber)
          ipv6_hp_bpf:
            name: $(os)_$(arch)/ipv6-hp-bpf
            os: linux
            dockerfilePath: $(ACN_DIR)/bpf-prog/ipv6-hp-bpf
            extraArgs: "--build-arg DEBUG=$(System.Debug)"
            archiveName: ipv6-hp-bpf
            archiveVersion: $(IPV6_HP_BPF_VERSION)
            imageTag: $(Build.BuildNumber)
          npm:
            name: $(os)_$(arch)/npm
            os: linux
            dockerfilePath: $(ACN_DIR)/npm
            extraArgs: '--build-arg NPM_AI_PATH=$(NPM_AI_PATH) --build-arg NPM_AI_ID=$(NPM_AI_ID)'
            archiveName: azure-npm
            archiveVersion: $(NPM_VERSION)
            imageTag: $(Build.BuildNumber)
      steps:
      - template: build/image.steps.yaml
        parameters:
          arch: $(ARCH)
          os: $(OS)
          name: $(name)
          dockerfile_path: $(dockerfilePath)
          build_tag: $(imageTag)
          extra_args: $(extraArgs)
          archive_file: $(archiveName)-$(OS)-$(ARCH)-$(archiveVersion)


  - stage: manifests
    displayName: "Image Manifests"
    dependsOn:
    - build
    variables:
      IMAGE_REPO_PATH: 'artifact/dd590928-4e04-48cb-9d3d-ee06c5f0e17f/buddy'

      IPAM_LINUX_AMD64_REF: $[ stageDependencies.build.images_linux_amd64.outputs['azure_ipam.detail.IMAGE_REFERENCE'] ]
      IPAM_LINUX_ARM64_REF: $[ stageDependencies.build.images_linux_arm64.outputs['azure_ipam.detail.IMAGE_REFERENCE'] ]
      IPAM_WINDOWS_AMD64_REF: $[ stageDependencies.build.images_windows_amd64.outputs['azure_ipam.detail.IMAGE_REFERENCE'] ]

      CNI_LINUX_AMD64_REF: $[ stageDependencies.build.images_linux_amd64.outputs['cni.detail.IMAGE_REFERENCE'] ]
      CNI_LINUX_ARM64_REF: $[ stageDependencies.build.images_linux_arm64.outputs['cni.detail.IMAGE_REFERENCE'] ]
      CNI_WINDOWS_AMD64_REF: $[ stageDependencies.build.images_windows_amd64.outputs['cni.detail.IMAGE_REFERENCE'] ]

      CNS_LINUX_AMD64_REF: $[ stageDependencies.build.images_linux_amd64.outputs['cns.detail.IMAGE_REFERENCE'] ]
      CNS_LINUX_ARM64_REF: $[ stageDependencies.build.images_linux_arm64.outputs['cns.detail.IMAGE_REFERENCE'] ]
      CNS_WINDOWS_AMD64_REF: $[ stageDependencies.build.images_windows_amd64.outputs['cns.detail.IMAGE_REFERENCE'] ]

      IPV6_LINUX_AMD64_REF: $[ stageDependencies.build.images_linux_amd64.outputs['ipv6_hp_bpf.detail.IMAGE_REFERENCE'] ]
      IPV6_LINUX_ARM64_REF: $[ stageDependencies.build.images_linux_arm64.outputs['ipv6_hp_bpf.detail.IMAGE_REFERENCE'] ]

      NPM_LINUX_AMD64_REF: $[ stageDependencies.build.images_linux_amd64.outputs['npm.detail.IMAGE_REFERENCE'] ]
      NPM_LINUX_ARM64_REF: $[ stageDependencies.build.images_linux_arm64.outputs['npm.detail.IMAGE_REFERENCE'] ]
      NPM_WINDOWS_AMD64_REF: $[ stageDependencies.build.images_windows_amd64.outputs['npm.detail.IMAGE_REFERENCE'] ]
    jobs:
    - template: build/manifests.jobs.yaml
      parameters:
        generate:
        - job: azure_ipam
          templateContext:
            name: azure-ipam
            image_tag: $(AZURE_IPAM_VERSION)
            platforms:
            - platform: linux/amd64
              imageReference: $(IPAM_LINUX_AMD64)
            - platform: linux/arm64
              imageReference: $(IPAM_LINUX_ARM64)
            - platform: windows/amd64
              osVersion: ltsc2022
              imageReference: $(IPAM_WINDOWS_AMD64)
        - job: cni
          templateContext:
            name: cni
            image_tag: $(CNI_VERSION)
            platforms:
            - platform: linux/amd64
              imageReference: $(CNI_LINUX_AMD64)
            - platform: linux/arm64
              imageReference: $(CNI_LINUX_ARM64)
            - platform: windows/amd64
              osVersion: ltsc2022
              imageReference: $(CNI_WINDOWS_AMD64)
        - job: cns
          templateContext:
            name: cns
            image_tag: $(CNS_VERSION)
            platforms:
            - platform: linux/amd64
              imageReference: $(CNS_LINUX_AMD64)
            - platform: linux/arm64
              imageReference: $(CNS_LINUX_ARM64)
            - platform: windows/amd64
              osVersion: ltsc2022
              imageReference: $(CNS_WINDOWS_AMD64)
        - job: ipv6_hp_bpf
          templateContext:
            name: ipv6-hp-bpf
            image_tag: $(IPV6_HP_BPF_VERSION)
            platforms:
            - platform: linux/amd64
              imageReference: $(IPV6_LINUX_AMD64)
            - platform: linux/arm64
              imageReference: $(IPV6_LINUX_ARM64)
        - job: npm
          templateContext:
            name: npm
            image_tag: $(NPM_VERSION)
            platforms:
            - platform: linux/amd64
              imageReference: $(NPM_LINUX_AMD64)
            - platform: linux/arm64
              imageReference: $(NPM_LINUX_ARM64)
            - platform: windows/amd64
              osVersion: ltsc2022
              imageReference: $(NPM_WINDOWS_AMD64)


#  - stage: e2e
#    displayName: "Run E2E Tests"
#    dependsOn:
#    - setup
#    - manifests
#    variables:
#      IMAGE_REPO_PATH: 'artifact/dd590928-4e04-48cb-9d3d-ee06c5f0e17f/buddy'
#      commitID: $[ stageDependencies.setup.env.outputs['EnvironmentalVariables.commitID'] ]
#    jobs:
#    - template: test/e2e/run-e2es.jobs.yaml
#      parameters:
#        scenarios:
#        # Cilium Swift E2E Tests
#        - job: cilium_podsubnet
#          displayName: "Cilium Podsubnet"
#          templateContext:
#            provision:
#            - cluster: "cilium-swift-$(commitID)"
#              type: podsubnet
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: cilium
#              vmSize: Standard_B2ms
#            e2e:
#            - 
#            logs:
#          steps:
#          - template: singletenancy/cilium/cilium-e2e-job-template.yaml
#    
#        # Cilium Nodesubnet E2E tests
#        - job: cilium_nodesubnet
#          displayName: "Cilium Nodesubnet"
#          templateContext:
#           clusterType: nodesubnet-byocni-nokubeproxy-up
#            clusters:
#            - cluster: "cilium-nodesubnet"
#              type: nodesubnet
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: cilium
#              vmSize: Standard_B2s
#            e2e:
#            - 
#            logs:
#          steps:
#          - template: singletenancy/cilium-nodesubnet/cilium-nodesubnet-e2e-job-template.yaml
#    
#        # Cilium Overlay E2E tests
#        - job: cilium_overlay
#          #clusterType: overlay-byocni-nokubeproxy-up
#          displayName: "Cilium on AKS Overlay"
#          templateContext:
#           clusterType: overlay-byocni-nokubeproxy-up
#            clusters:
#            - cluster: "cilium-overlay"
#              type: overlay
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: cilium
#              vmSize: Standard_B2ms
#            e2e:
#            - 
#            logs:
#          steps:
#          - template: singletenancy/cilium-overlay/cilium-overlay-e2e-job-template.yaml
#    
#        # Cilium Dualstack Overlay E2E tests
#        - job: cilium_overlay_ds
#          displayName: "Cilium on AKS Dualstack Overlay"
#          #clusterType: dualstack-byocni-nokubeproxy-up
#          templateContext:
#            clusters:
#            - cluster: "cilium-overlay-ds"
#              type: overlay
#              region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
#              dataplane: cilium
#              vmSize: Standard_B2ms
#              capabilities:
#                dualstackEnabled: true
#            e2e:
#            - 
#            logs:
#          steps:
#          - template: singletenancy/cilium-dualstack-overlay/cilium-dualstackoverlay-e2e-job-template.yaml
#    
#        # Cilium Overlay with hubble E2E tests
#        - job: cilium_h_overlay
#          displayName: "Cilium (with Hubble) on AKS Overlay"
#          #clusterType: overlay-byocni-nokubeproxy-up
#          templateContext:
#            clusters:
#            - cluster: "cilium-h-overlay"
#              type: overlay
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: cilium
#              vmSize: Standard_B2ms
#              capabilities:
#                hubbleEnabled: true
#            e2e:
#            - 
#            logs:
#          steps:
#          - template: singletenancy/cilium-overlay-withhubble/cilium-overlay-e2e-job-template.yaml
#    
#        # Azure Overlay E2E tests
#        - job: overlay_linux
#          displayName: "Azure CNI (Linux) Overlay"
#            #clusterType: overlay-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "overlay-linux"
#              type: overlay
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: linux
#              vmSize: Standard_B2ms
#            e2e:
#              - scale: 100
#            logs:
#          steps:
#          - template: singletenancy/azure-cni-overlay/azure-cni-overlay-e2e-job-template.yaml
#    
#        # Azure Windows Overlay E2E tests
#        - job: overlay_windows
#          displayName: "Azure CNI (Windows) Overlay"
#            #clusterType: overlay-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "overlay-windows"
#              type: overlay
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: windows
#              vmSize: Standard_B2ms
#            e2e:
#              - scale: 50
#            logs:
#          steps:
#          - template: singletenancy/azure-cni-overlay/azure-cni-overlay-e2e-job-template.yaml
#    
#        # Azure Overlay E2E Stateless CNI tests
#        - job: overlay_stateless
#          displayName: "Azure CNI Stateless (Windows) Overlay"
#            #clusterType: overlay-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "stateless-overlay-win"
#              type: overlay
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: windows
#              vmSize: Standard_B2ms
#            e2e:
#            logs:
#          steps:
#          - template: singletenancy/azure-cni-overlay-stateless/azure-cni-overlay-stateless-e2e-job-template.yaml
#    
#        # AKS Swift E2E tests
#        - job: podsubnet_linux
#          displayName: "AKS Swift (Ubuntu)"
#            #clusterType: swift-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "swift-linux"
#              type: podsubnet
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: ubuntu
#              vmSize: Standard_B2ms
#            e2e:
#            logs:
#          steps:
#          - template: singletenancy/aks-swift/e2e-job-template.yaml
#    
#        # AKS Swift Vnet Scale E2E tests
#        - job: podsubnet_vnetscale
#          displayName: "AKS Swift VNetScale (Ubuntu)"
#          #clusterType: vnetscale-swift-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "vnetscale"
#              type: podsubnet
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              k8sVersion: "1.30"
#              os: ubuntu
#              vmSize: Standard_B2ms
#              capabilities:
#                vnetscaleEnabled: true
#            e2e:
#            logs:
#          steps:
#          - template: singletenancy/aks-swift/e2e-job-template.yaml
#    
#        # CNIv1 E2E tests
#        - job: cniv1
#          displayName: "CNIv1 (Ubuntu)"
#          #clusterType: cniv1-up
#          templateContext:
#            clusters:
#            - cluster: "cniv1"
#              type: cniv1
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: ubuntu
#              vmSize: Standard_B2s
#              k8sVersion: 1.25
#            e2e:
#            - scale: 100
#            logs:
#          steps:
#          - template: singletenancy/aks/e2e-job-template.yaml
#    
#        # CNIv1 Windows E2E Tests
#        - job: cniv1_windows
#          displayName: "CNIv1 (Windows)"
#          #clusterType: cniv1-up
#          templateContext:
#            clusters:
#            - cluster: "cniv1-windows"
#              type: cniv1
#              region: $(REGION_AKS_CLUSTER_TEST)
#              dataplane: kubenet
#              os: windows
#              osVersion: "ltsc2022"
#              vmSize: Standard_B2ms
#              k8sVersion: 1.25
#            e2e:
#            - scale: 50
#            logs:
#          steps:
#          - template: singletenancy/aks/e2e-job-template.yaml
#    
#        # CNI Dualstack Overlay E2E Tests
#        - job: overlay_ds_linux
#          displayName: "Dualstack Overlay (Ubuntu)"
#          #clusterType: dualstack-overlay-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "overlay-ds"
#              type: overlay
#              region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
#              dataplane: kubenet
#              os: linux
#              vmSize: Standard_B2ms
#              capabilities:
#                dualstackEnabled: true
#            e2e:
#            - scale: 100
#            logs:
#          steps:
#          - template: singletenancy/dualstack-overlay/dualstackoverlay-e2e-job-template.yaml
#    
#        # CNI Dualstack Overlay E2E Tests
#        - job: overlay_ds_windows
#          displayName: "Dualstack Overlay (Windows)"
#          #clusterType: dualstack-overlay-byocni-up
#          templateContext:
#            clusters:
#            - cluster: "overlay-ds-win"
#              type: overlay
#              region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
#              dataplane: kubenet
#              os: windows
#              vmSize: Standard_B2ms
#              capabilities:
#                dualstackEnabled: true
#            e2e:
#            - scale: 50
#            logs:
#          steps:
#          - template: singletenancy/cilium-dualstack-overlay/cilium-dualstackoverlay-e2e-job-template.yaml
  # Cilium Podsubnet E2E tests
  - template: singletenancy/cilium/cilium-e2e-job-template.yaml
    parameters:
      name: "cilium_e2e"
      displayName: Cilium
      clusterType: swift-byocni-nokubeproxy-up
      clusterName: "ciliume2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests

  # Cilium Nodesubnet E2E tests
  - template: singletenancy/cilium-nodesubnet/cilium-nodesubnet-e2e-job-template.yaml
    parameters:
      name: "cilium_nodesubnet_e2e"
      displayName: Cilium NodeSubnet
      clusterType: nodesubnet-byocni-nokubeproxy-up
      clusterName: "cilndsubnete2e"
      vmSize: Standard_B2s
      k8sVersion: ""
      dependsOn: manifests

  # Cilium Overlay E2E tests
  - template: singletenancy/cilium-overlay/cilium-overlay-e2e-job-template.yaml
    parameters:
      name: "cilium_overlay_e2e"
      displayName: Cilium on AKS Overlay
      clusterType: overlay-byocni-nokubeproxy-up
      clusterName: "cilovere2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests

  # Cilium Dualstack Overlay E2E tests
  - template: singletenancy/cilium-dualstack-overlay/cilium-dualstackoverlay-e2e-job-template.yaml
    parameters:
      name: "cilium_dualstackoverlay_e2e"
      displayName: Cilium on AKS DualStack Overlay
      os: linux
      clusterType: dualstack-byocni-nokubeproxy-up
      clusterName: "cildsovere2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests

      # Cilium Overlay with hubble E2E tests
  - template: singletenancy/cilium-overlay-withhubble/cilium-overlay-e2e-job-template.yaml
    parameters:
      name: "cilium_h_overlay_e2e"
      displayName: Cilium on AKS Overlay with Hubble
      clusterType: overlay-byocni-nokubeproxy-up
      clusterName: "cilwhleovere2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests
      testHubble: true

  # Azure Overlay E2E tests
  - template: singletenancy/azure-cni-overlay/azure-cni-overlay-e2e-job-template.yaml
    parameters:
      name: "linux_azure_overlay_e2e"
      displayName: Azure Overlay Linux
      os: linux
      clusterType: overlay-byocni-up
      clusterName: "linuxazovere2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests
      scaleup: 100
  
  - template: singletenancy/azure-cni-overlay/azure-cni-overlay-e2e-job-template.yaml
    parameters:
      name: "win_azure_overlay_e2e"
      displayName: Azure Overlay Windows
      os: windows
      clusterType: overlay-byocni-up
      clusterName: "winazovere2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests
      scaleup: 50

  # Azure Overlay E2E Stateless CNI tests
  - template: singletenancy/azure-cni-overlay-stateless/azure-cni-overlay-stateless-e2e-job-template.yaml
    parameters:
      name: "azure_overlay_stateless_e2e"
      displayName: Azure Stateless CNI Overlay
      os: windows
      clusterType: overlay-byocni-up
      clusterName: "statelesswin"
      vmSize: Standard_B2ms
      dependsOn: manifests

  # AKS Swift E2E tests
  - template: singletenancy/aks-swift/e2e-job-template.yaml
    parameters:
      name: "aks_swift_e2e"
      displayName: AKS Swift Ubuntu
      os: linux
      clusterType: swift-byocni-up
      clusterName: "swifte2e"
      vmSize: Standard_B2ms
      k8sVersion: ""
      dependsOn: manifests

  # AKS Swift Vnet Scale E2E tests
  - template: singletenancy/aks-swift/e2e-job-template.yaml
    parameters:
      name: "aks_swift_vnetscale_e2e"
      displayName: AKS Swift Vnet Scale Ubuntu
      os: linux
      clusterType: vnetscale-swift-byocni-up
      clusterName: "vscaleswifte2e"
      vmSize: Standard_B2ms
      k8sVersion: "1.30"
      dependsOn: manifests

  # CNIv1 E2E tests
  - template: singletenancy/aks/e2e-job-template.yaml
    parameters:
      name: "aks_ubuntu_22_linux_e2e"
      displayName: AKS Ubuntu 22
      arch: "amd64"
      os: "linux"
      clusterType: cniv1-up
      clusterName: "ubuntu22e2e"
      vmSize: Standard_B2s
      k8sVersion: 1.25
      scaleup: 100
      dependsOn: manifests

  - template: singletenancy/aks/e2e-job-template.yaml
    parameters:
      name: "aks_windows_22_e2e"
      displayName: AKS Windows 2022
      arch: amd64
      os: "windows"
      clusterType: cniv1-up
      clusterName: "win22e2e"
      vmSize: Standard_B2ms
      os_version: "ltsc2022"
      scaleup: 50
      dependsOn: manifests

  # CNI dual stack overlay E2E tests
  - template: singletenancy/dualstack-overlay/dualstackoverlay-e2e-job-template.yaml
    parameters:
      name: "linux_dualstackoverlay_e2e"
      displayName: AKS DualStack Overlay Linux
      os: linux
      clusterType: dualstack-overlay-byocni-up
      clusterName: "linuxdsovere2e"
      vmSize: Standard_B2ms
      dependsOn: manifests
      scaleup: 100

  - template: singletenancy/dualstack-overlay/dualstackoverlay-e2e-job-template.yaml
    parameters:
      name: "win_dualstackoverlay_e2e"
      displayName: AKS DualStack Overlay Windows
      os: windows
      clusterType: dualstack-overlay-byocni-up
      clusterName: "windsovere2e"
      vmSize: Standard_B2ms
      dependsOn: manifests
      scaleup: 50


  - stage: delete
    displayName: Delete Clusters
    condition: always()
    dependsOn:
      - setup
      - linux_azure_overlay_e2e
      - win_azure_overlay_e2e
      - azure_overlay_stateless_e2e
      - aks_swift_e2e
      - cilium_e2e
      - cilium_nodesubnet_e2e
      - cilium_overlay_e2e
      - cilium_h_overlay_e2e
      - aks_ubuntu_22_linux_e2e
      - aks_swift_vnetscale_e2e
      - aks_windows_22_e2e
      - linux_dualstackoverlay_e2e
      - win_dualstackoverlay_e2e
      - cilium_dualstackoverlay_e2e
    variables:
      commitID: $[ stagedependencies.setup.env.outputs['EnvironmentalVariables.commitID'] ]
    jobs:
    - job: delete_build
      displayName: Delete Cluster
      pool:
        name: "$(BUILD_POOL_NAME_DEFAULT)"
        isCustom: true
        type: linux
      strategy:
        matrix:
          cilium_e2e:
            name: cilium_e2e
            clusterName: "ciliume2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          cilium_nodesubnet_e2e:
            name: cilium_nodesubnet_e2e
            clusterName: "cilndsubnete2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          cilium_overlay_e2e:
            name: cilium_overlay_e2e
            clusterName: "cilovere2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          cilium_h_overlay_e2e:
            name: cilium_h_overlay_e2e
            clusterName: "cilwhleovere2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          linux_azure_overlay_e2e:
            name: linux_azure_overlay_e2e
            clusterName: "linuxazovere2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          windows_azure_overlay_e2e:
            name: win_azure_overlay_e2e
            clusterName: "winazovere2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          azure_overlay_stateless_e2e:
            name: azure_overlay_stateless_e2e
            clusterName: "statelesswin"
            region: $(REGION_AKS_CLUSTER_TEST)
          aks_swift_e2e:
            name: aks_swift_e2e
            clusterName: "swifte2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          aks_swift_vnetscale_e2e:
            name: aks_swift_vnetscale_e2e
            clusterName: "vscaleswifte2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          aks_ubuntu_22_linux_e2e:
            name: aks_ubuntu_22_linux_e2e
            clusterName: "ubuntu22e2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          aks_windows_22_e2e:
            name: aks_windows_22_e2e
            clusterName: "win22e2e"
            region: $(REGION_AKS_CLUSTER_TEST)
          linux_dualstackoverlay_e2e:
            name: linux_dualstackoverlay_e2e
            clusterName: "linuxdsovere2e"
            region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
          windows_dualstackoverlay_e2e:
            name: windows_dualstackoverlay_e2e
            clusterName: "windsovere2e"
            region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
          cilium_dualstackoverlay_e2e:
            name: cilium_dualstackoverlay_e2e
            clusterName: "cildsovere2e"
            region: $(REGION_DUALSTACKOVERLAY_CLUSTER_TEST)
      steps:
      - checkout: azure-container-networking
      - template: templates/delete-cluster.yaml
        parameters:
          name: $(name)
          clusterName: $(clusterName)-$(commitID)
          region: $(region)
          sub: $(SUB_AZURE_NETWORK_AGENT_BUILD_VALIDATIONS)
          svcConn: $(BUILD_VALIDATIONS_SERVICE_CONNECTION)
